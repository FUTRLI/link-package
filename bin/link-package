#!/usr/bin/env bash

set -euo pipefail

if [ $# -eq 0 ]; then
    echo "You must provide an argument for the package you wish to link"
    exit 1
fi

PACKAGE=${1}
MONOREPO_ROOT=${LINK_PACKAGE_ROOT:-~/workspace/frontend-platform}
DIST_FOLDER=${MONOREPO_ROOT}/packages/${PACKAGE}/build
BUILD_COMMAND=${LINK_PACKAGE_COMMAND:-"yarn build"}

if [ -f "${MONOREPO_ROOT}/packages/${PACKAGE}/package.json" ]; then
    echo "package.json found for ${PACKAGE}"
else
    echo "package.json not found in ${MONOREPO_ROOT}/packages/${PACKAGE}!"
    exit 1
fi

(cd ${MONOREPO_ROOT} && ${BUILD_COMMAND} && cd ${DIST_FOLDER} && npm pack)
TARBALL=$(ls ${DIST_FOLDER}/*.tgz)
echo "Installing ${TARBALL}"
npm i ${TARBALL}
